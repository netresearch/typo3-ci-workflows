name: SLSA Provenance

on:
  workflow_call:
    inputs:
      version:
        description: 'Release version tag (e.g. v4.0.0). Auto-detected from workflow_run trigger.'
        required: false
        type: string
        default: ''
      artifact-patterns:
        description: 'Glob patterns for release assets to include (space-separated)'
        required: false
        type: string
        default: '*.tar.gz *.zip *.spdx.json *.cdx.json SHA256SUMS.txt checksums.txt'

permissions: {}

jobs:
  prepare:
    name: Prepare provenance subjects
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: >-
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'
    permissions:
      contents: read
    outputs:
      version: ${{ steps.version.outputs.version }}
      base64-subjects: ${{ steps.subjects.outputs.base64-subjects }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
        with:
          egress-policy: audit

      - name: Determine version
        id: version
        env:
          INPUT_VERSION: ${{ inputs.version }}
          HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
        run: |
          if [ -n "$INPUT_VERSION" ]; then
            echo "version=$INPUT_VERSION" >> "$GITHUB_OUTPUT"
          elif [ -n "$HEAD_BRANCH" ]; then
            echo "version=$HEAD_BRANCH" >> "$GITHUB_OUTPUT"
          else
            echo "::error::No version provided and no workflow_run head_branch available"
            exit 1
          fi

      - name: Download release assets
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: ${{ steps.version.outputs.version }}
          PATTERNS: ${{ inputs.artifact-patterns }}
        run: |
          mkdir -p artifacts
          cd artifacts
          for pattern in $PATTERNS; do
            gh release download "$VERSION" \
              --repo "$GITHUB_REPOSITORY" \
              --pattern "$pattern" 2>/dev/null || true
          done
          if [ -z "$(ls -A .)" ]; then
            echo "::error::No release assets downloaded for version $VERSION"
            exit 1
          fi
          echo "Downloaded assets:"
          ls -la

      - name: Generate base64-encoded subjects
        id: subjects
        working-directory: artifacts
        run: |
          SUBJECTS=$(sha256sum ./* | base64 -w0)
          echo "base64-subjects=$SUBJECTS" >> "$GITHUB_OUTPUT"

  provenance:
    name: Generate SLSA provenance
    needs: prepare
    permissions:
      actions: read
      contents: write
      id-token: write
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@f7dd8c54c2067bafc12ca7a55595d5ee9b75204a # v2.1.0
    with:
      base64-subjects: ${{ needs.prepare.outputs.base64-subjects }}
      upload-assets: true
      upload-tag-name: ${{ needs.prepare.outputs.version }}
      compile-generator: true
      private-repository: true
