name: CI

on:
  workflow_call:
    inputs:
      # PHP / TYPO3 matrix
      php-versions:
        description: JSON array of PHP versions
        type: string
        default: '["8.4"]'
      typo3-versions:
        description: JSON array of TYPO3 versions (e.g. '["^12.4", "^13.4"]')
        type: string
        default: '["^13.4"]'
      matrix-exclude:
        description: JSON array of {php, typo3} combinations to exclude
        type: string
        default: '[]'

      # Feature flags
      run-lint:
        description: Run PHP syntax lint
        type: boolean
        default: true
      run-cgl:
        description: Run code style check (PHP-CS-Fixer)
        type: boolean
        default: true
      run-phpstan:
        description: Run PHPStan static analysis
        type: boolean
        default: true
      run-rector:
        description: Run Rector dry-run
        type: boolean
        default: false
      run-unit-tests:
        description: Run PHPUnit unit tests
        type: boolean
        default: true
      run-functional-tests:
        description: Run PHPUnit functional tests
        type: boolean
        default: false

      # Tool commands (empty = auto-detect from composer scripts)
      cgl-command:
        description: CGL command (default uses composer ci:test:php:cgl or ci:cgl -- --dry-run)
        type: string
        default: ''
      phpstan-command:
        description: PHPStan command (default uses composer ci:test:php:phpstan)
        type: string
        default: ''
      rector-command:
        description: Rector command (default uses composer ci:test:php:rector)
        type: string
        default: ''
      unit-test-command:
        description: Unit test command (default uses composer ci:test:php:unit)
        type: string
        default: ''
      functional-test-command:
        description: Functional test command (default uses composer ci:test:php:functional)
        type: string
        default: ''

      # TYPO3 packages to require for matrix testing
      typo3-packages:
        description: 'JSON array of TYPO3 packages (e.g. ["typo3/cms-core", "typo3/cms-backend"])'
        type: string
        default: '["typo3/cms-core"]'

      # PHP extensions
      php-extensions:
        description: PHP extensions to install
        type: string
        default: intl, mbstring, json

      # Functional test database
      functional-test-db:
        description: Database for functional tests (sqlite, mysql, mariadb, postgres)
        type: string
        default: sqlite
      db-image:
        description: Docker image for database service
        type: string
        default: 'mysql:9.6'

      # Coverage
      upload-coverage:
        description: Upload coverage to Codecov
        type: boolean
        default: false
      coverage-tool:
        description: Coverage driver (pcov or xdebug)
        type: string
        default: pcov

      # Incompatible dev deps
      remove-dev-deps:
        description: 'JSON array of dev deps to remove for TYPO3 version compat (e.g. [{"dep":"saschaegerer/phpstan-typo3","only-for":"^13"}])'
        type: string
        default: '[]'

    secrets:
      CODECOV_TOKEN:
        required: false

permissions: {}

jobs:
  lint:
    name: Lint (PHP ${{ matrix.php }})
    if: ${{ inputs.run-lint }}
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        php: ${{ fromJSON(inputs.php-versions) }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup PHP
        uses: shivammathur/setup-php@44454db4f0199b8b9685a5d763dc37cbf79108e1 # v2.36.0
        with:
          php-version: ${{ matrix.php }}
          coverage: none

      - name: PHP syntax check
        run: find . -name '*.php' -not -path './.Build/*' -not -path './vendor/*' | xargs -P4 -n1 php -l > /dev/null

  cgl:
    name: Code Style
    if: ${{ inputs.run-cgl }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup PHP
        uses: shivammathur/setup-php@44454db4f0199b8b9685a5d763dc37cbf79108e1 # v2.36.0
        with:
          php-version: ${{ fromJSON(inputs.php-versions)[0] }}
          extensions: ${{ inputs.php-extensions }}
          tools: composer:v2
          coverage: none

      - name: Get Composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> "$GITHUB_OUTPUT"

      - name: Cache Composer dependencies
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-cgl-${{ hashFiles('**/composer.json') }}
          restore-keys: ${{ runner.os }}-composer-cgl-

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: Run code style check
        env:
          CGL_COMMAND: ${{ inputs.cgl-command }}
        run: |
          if [[ -n "$CGL_COMMAND" ]]; then
            bash -c "$CGL_COMMAND"
          elif composer run-script --list 2>/dev/null | grep -q 'ci:test:php:cgl'; then
            composer ci:test:php:cgl
          elif composer run-script --list 2>/dev/null | grep -q 'ci:cgl'; then
            composer ci:cgl -- --dry-run
          elif composer run-script --list 2>/dev/null | grep -q 'ci:lint:php'; then
            composer ci:lint:php
          elif composer run-script --list 2>/dev/null | grep -q 'code:style:check'; then
            composer code:style:check
          else
            echo "No CGL script found, skipping"
          fi

  phpstan:
    name: PHPStan (PHP ${{ matrix.php }}, TYPO3 ${{ matrix.typo3 }})
    if: ${{ inputs.run-phpstan }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        php: ${{ fromJSON(inputs.php-versions) }}
        typo3: ${{ fromJSON(inputs.typo3-versions) }}
        exclude: ${{ fromJSON(inputs.matrix-exclude) }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup PHP
        uses: shivammathur/setup-php@44454db4f0199b8b9685a5d763dc37cbf79108e1 # v2.36.0
        with:
          php-version: ${{ matrix.php }}
          extensions: ${{ inputs.php-extensions }}
          tools: composer:v2
          coverage: none

      - name: Get Composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> "$GITHUB_OUTPUT"

      - name: Cache Composer dependencies
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ matrix.php }}-${{ matrix.typo3 }}-${{ hashFiles('**/composer.json') }}
          restore-keys: |
            ${{ runner.os }}-composer-${{ matrix.php }}-${{ matrix.typo3 }}-
            ${{ runner.os }}-composer-${{ matrix.php }}-

      - name: Remove incompatible dev deps
        env:
          REMOVE_DEV_DEPS: ${{ inputs.remove-dev-deps }}
          TYPO3_VERSION: ${{ matrix.typo3 }}
        run: |
          if [[ "$REMOVE_DEV_DEPS" == "[]" ]]; then exit 0; fi
          echo "$REMOVE_DEV_DEPS" | python3 -c "
          import json, os, sys, subprocess
          entries = json.load(sys.stdin)
          typo3 = os.environ['TYPO3_VERSION']
          for entry in entries:
              only_for = entry.get('only-for', '')
              if only_for and not typo3.startswith(only_for):
                  dep = entry['dep']
                  print(f'Removing {dep} (only compatible with {only_for})')
                  subprocess.run(['composer', 'remove', '--dev', '--no-update', dep], check=True)
          "

      - name: Install TYPO3
        env:
          TYPO3_VERSION: ${{ matrix.typo3 }}
          TYPO3_PACKAGES: ${{ inputs.typo3-packages }}
        run: |
          for pkg in $(echo "$TYPO3_PACKAGES" | jq -r '.[]'); do
            composer require --no-update "$pkg:${TYPO3_VERSION}"
          done
          composer install --prefer-dist --no-progress

      - name: Run PHPStan
        env:
          PHPSTAN_COMMAND: ${{ inputs.phpstan-command }}
        run: |
          if [[ -n "$PHPSTAN_COMMAND" ]]; then
            bash -c "$PHPSTAN_COMMAND"
          elif composer run-script --list 2>/dev/null | grep -q 'ci:test:php:phpstan'; then
            composer ci:test:php:phpstan -- --error-format=github
          elif composer run-script --list 2>/dev/null | grep -q 'ci:stan'; then
            composer ci:stan
          elif composer run-script --list 2>/dev/null | grep -q 'code:phpstan'; then
            composer code:phpstan
          else
            echo "No PHPStan script found, skipping"
          fi

  rector:
    name: Rector
    if: ${{ inputs.run-rector }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup PHP
        uses: shivammathur/setup-php@44454db4f0199b8b9685a5d763dc37cbf79108e1 # v2.36.0
        with:
          php-version: ${{ fromJSON(inputs.php-versions)[0] }}
          extensions: ${{ inputs.php-extensions }}
          tools: composer:v2
          coverage: none

      - name: Get Composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> "$GITHUB_OUTPUT"

      - name: Cache Composer dependencies
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-rector-${{ hashFiles('**/composer.json') }}
          restore-keys: ${{ runner.os }}-composer-rector-

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: Run Rector
        env:
          RECTOR_COMMAND: ${{ inputs.rector-command }}
        run: |
          if [[ -n "$RECTOR_COMMAND" ]]; then
            bash -c "$RECTOR_COMMAND"
          elif composer run-script --list 2>/dev/null | grep -q 'ci:test:php:rector'; then
            composer ci:test:php:rector
          else
            echo "No Rector script found, skipping"
          fi

  unit-tests:
    name: Unit Tests (PHP ${{ matrix.php }}, TYPO3 ${{ matrix.typo3 }})
    if: ${{ inputs.run-unit-tests }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        php: ${{ fromJSON(inputs.php-versions) }}
        typo3: ${{ fromJSON(inputs.typo3-versions) }}
        exclude: ${{ fromJSON(inputs.matrix-exclude) }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup PHP
        uses: shivammathur/setup-php@44454db4f0199b8b9685a5d763dc37cbf79108e1 # v2.36.0
        with:
          php-version: ${{ matrix.php }}
          extensions: ${{ inputs.php-extensions }}
          tools: composer:v2
          coverage: ${{ inputs.upload-coverage && inputs.coverage-tool || 'none' }}

      - name: Get Composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> "$GITHUB_OUTPUT"

      - name: Cache Composer dependencies
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ matrix.php }}-${{ matrix.typo3 }}-${{ hashFiles('**/composer.json') }}
          restore-keys: |
            ${{ runner.os }}-composer-${{ matrix.php }}-${{ matrix.typo3 }}-
            ${{ runner.os }}-composer-${{ matrix.php }}-

      - name: Remove incompatible dev deps
        env:
          REMOVE_DEV_DEPS: ${{ inputs.remove-dev-deps }}
          TYPO3_VERSION: ${{ matrix.typo3 }}
        run: |
          if [[ "$REMOVE_DEV_DEPS" == "[]" ]]; then exit 0; fi
          echo "$REMOVE_DEV_DEPS" | python3 -c "
          import json, os, sys, subprocess
          entries = json.load(sys.stdin)
          typo3 = os.environ['TYPO3_VERSION']
          for entry in entries:
              only_for = entry.get('only-for', '')
              if only_for and not typo3.startswith(only_for):
                  dep = entry['dep']
                  print(f'Removing {dep} (only compatible with {only_for})')
                  subprocess.run(['composer', 'remove', '--dev', '--no-update', dep], check=True)
          "

      - name: Install TYPO3
        env:
          TYPO3_VERSION: ${{ matrix.typo3 }}
          TYPO3_PACKAGES: ${{ inputs.typo3-packages }}
        run: |
          for pkg in $(echo "$TYPO3_PACKAGES" | jq -r '.[]'); do
            composer require --no-update "$pkg:${TYPO3_VERSION}"
          done
          composer install --prefer-dist --no-progress

      - name: Run unit tests
        env:
          UNIT_TEST_COMMAND: ${{ inputs.unit-test-command }}
          UPLOAD_COVERAGE: ${{ inputs.upload-coverage }}
        run: |
          if [[ -n "$UNIT_TEST_COMMAND" ]]; then
            bash -c "$UNIT_TEST_COMMAND"
          elif composer run-script --list 2>/dev/null | grep -q 'ci:test:php:unit'; then
            if [[ "$UPLOAD_COVERAGE" == "true" ]]; then
              composer ci:test:php:unit -- --coverage-clover=coverage-unit.xml
            else
              composer ci:test:php:unit -- --no-coverage
            fi
          else
            echo "No unit test script found, skipping"
          fi

      - name: Upload coverage to Codecov
        if: ${{ inputs.upload-coverage }}
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: coverage-unit.xml
          flags: unit
          fail_ci_if_error: false

  functional-tests:
    name: Functional Tests (PHP ${{ matrix.php }}, TYPO3 ${{ matrix.typo3 }})
    if: ${{ inputs.run-functional-tests && inputs.functional-test-db != 'sqlite' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        php: ${{ fromJSON(inputs.php-versions) }}
        typo3: ${{ fromJSON(inputs.typo3-versions) }}
        exclude: ${{ fromJSON(inputs.matrix-exclude) }}
    services:
      db:
        image: ${{ inputs.db-image }}
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: typo3_test
          POSTGRES_PASSWORD: root
          POSTGRES_DB: typo3_test
        ports:
          - 3306:3306
          - 5432:5432
        options: >-
          --health-cmd="${{ inputs.functional-test-db == 'postgres' && 'pg_isready -U postgres' || 'mysqladmin ping --silent' }}"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup PHP
        uses: shivammathur/setup-php@44454db4f0199b8b9685a5d763dc37cbf79108e1 # v2.36.0
        with:
          php-version: ${{ matrix.php }}
          extensions: ${{ inputs.php-extensions }}, pdo_mysql, pdo_sqlite, pdo_pgsql
          tools: composer:v2
          coverage: ${{ inputs.upload-coverage && inputs.coverage-tool || 'none' }}

      - name: Get Composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> "$GITHUB_OUTPUT"

      - name: Cache Composer dependencies
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-func-${{ matrix.php }}-${{ matrix.typo3 }}-${{ hashFiles('**/composer.json') }}
          restore-keys: ${{ runner.os }}-composer-func-${{ matrix.php }}-

      - name: Remove incompatible dev deps
        env:
          REMOVE_DEV_DEPS: ${{ inputs.remove-dev-deps }}
          TYPO3_VERSION: ${{ matrix.typo3 }}
        run: |
          if [[ "$REMOVE_DEV_DEPS" == "[]" ]]; then exit 0; fi
          echo "$REMOVE_DEV_DEPS" | python3 -c "
          import json, os, sys, subprocess
          entries = json.load(sys.stdin)
          typo3 = os.environ['TYPO3_VERSION']
          for entry in entries:
              only_for = entry.get('only-for', '')
              if only_for and not typo3.startswith(only_for):
                  dep = entry['dep']
                  print(f'Removing {dep} (only compatible with {only_for})')
                  subprocess.run(['composer', 'remove', '--dev', '--no-update', dep], check=True)
          "

      - name: Install TYPO3
        env:
          TYPO3_VERSION: ${{ matrix.typo3 }}
          TYPO3_PACKAGES: ${{ inputs.typo3-packages }}
        run: |
          for pkg in $(echo "$TYPO3_PACKAGES" | jq -r '.[]'); do
            composer require --no-update "$pkg:${TYPO3_VERSION}"
          done
          composer install --prefer-dist --no-progress

      - name: Run functional tests
        env:
          FUNCTIONAL_TEST_COMMAND: ${{ inputs.functional-test-command }}
          UPLOAD_COVERAGE: ${{ inputs.upload-coverage }}
          typo3DatabaseDriver: ${{ inputs.functional-test-db == 'postgres' && 'pdo_pgsql' || 'mysqli' }}
          typo3DatabaseHost: 127.0.0.1
          typo3DatabasePort: ${{ inputs.functional-test-db == 'postgres' && '5432' || '3306' }}
          typo3DatabaseName: typo3_test
          typo3DatabaseUsername: ${{ inputs.functional-test-db == 'postgres' && 'postgres' || 'root' }}
          typo3DatabasePassword: root
        run: |
          if [[ -n "$FUNCTIONAL_TEST_COMMAND" ]]; then
            bash -c "$FUNCTIONAL_TEST_COMMAND"
          elif composer run-script --list 2>/dev/null | grep -q 'ci:test:php:functional'; then
            if [[ "$UPLOAD_COVERAGE" == "true" ]]; then
              composer ci:test:php:functional -- --coverage-clover=coverage-functional.xml
            else
              composer ci:test:php:functional -- --no-coverage
            fi
          else
            echo "No functional test script found, skipping"
          fi

      - name: Upload coverage to Codecov
        if: ${{ inputs.upload-coverage }}
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: coverage-functional.xml
          flags: functional
          fail_ci_if_error: false

  functional-tests-sqlite:
    name: Functional Tests SQLite (PHP ${{ matrix.php }}, TYPO3 ${{ matrix.typo3 }})
    if: ${{ inputs.run-functional-tests && inputs.functional-test-db == 'sqlite' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        php: ${{ fromJSON(inputs.php-versions) }}
        typo3: ${{ fromJSON(inputs.typo3-versions) }}
        exclude: ${{ fromJSON(inputs.matrix-exclude) }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup PHP
        uses: shivammathur/setup-php@44454db4f0199b8b9685a5d763dc37cbf79108e1 # v2.36.0
        with:
          php-version: ${{ matrix.php }}
          extensions: ${{ inputs.php-extensions }}, pdo_sqlite
          tools: composer:v2
          coverage: ${{ inputs.upload-coverage && inputs.coverage-tool || 'none' }}

      - name: Get Composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> "$GITHUB_OUTPUT"

      - name: Cache Composer dependencies
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-func-${{ matrix.php }}-${{ matrix.typo3 }}-${{ hashFiles('**/composer.json') }}
          restore-keys: ${{ runner.os }}-composer-func-${{ matrix.php }}-

      - name: Remove incompatible dev deps
        env:
          REMOVE_DEV_DEPS: ${{ inputs.remove-dev-deps }}
          TYPO3_VERSION: ${{ matrix.typo3 }}
        run: |
          if [[ "$REMOVE_DEV_DEPS" == "[]" ]]; then exit 0; fi
          echo "$REMOVE_DEV_DEPS" | python3 -c "
          import json, os, sys, subprocess
          entries = json.load(sys.stdin)
          typo3 = os.environ['TYPO3_VERSION']
          for entry in entries:
              only_for = entry.get('only-for', '')
              if only_for and not typo3.startswith(only_for):
                  dep = entry['dep']
                  print(f'Removing {dep} (only compatible with {only_for})')
                  subprocess.run(['composer', 'remove', '--dev', '--no-update', dep], check=True)
          "

      - name: Install TYPO3
        env:
          TYPO3_VERSION: ${{ matrix.typo3 }}
          TYPO3_PACKAGES: ${{ inputs.typo3-packages }}
        run: |
          for pkg in $(echo "$TYPO3_PACKAGES" | jq -r '.[]'); do
            composer require --no-update "$pkg:${TYPO3_VERSION}"
          done
          composer install --prefer-dist --no-progress

      - name: Run functional tests
        env:
          FUNCTIONAL_TEST_COMMAND: ${{ inputs.functional-test-command }}
          UPLOAD_COVERAGE: ${{ inputs.upload-coverage }}
          typo3DatabaseDriver: pdo_sqlite
        run: |
          if [[ -n "$FUNCTIONAL_TEST_COMMAND" ]]; then
            bash -c "$FUNCTIONAL_TEST_COMMAND"
          elif composer run-script --list 2>/dev/null | grep -q 'ci:test:php:functional'; then
            if [[ "$UPLOAD_COVERAGE" == "true" ]]; then
              composer ci:test:php:functional -- --coverage-clover=coverage-functional.xml
            else
              composer ci:test:php:functional -- --no-coverage
            fi
          else
            echo "No functional test script found, skipping"
          fi

      - name: Upload coverage to Codecov
        if: ${{ inputs.upload-coverage }}
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: coverage-functional.xml
          flags: functional
          fail_ci_if_error: false
